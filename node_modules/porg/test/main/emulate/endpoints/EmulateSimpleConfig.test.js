import { testCaseRunner, logger, server } from '#/TestTemplate'

testCaseRunner('simple', 'simple', server => {
  server.route({
    path: '/api/emulate/auth/no-auth',
    method: 'GET',
    handler: async (request, h) => {
      return request.auth.credentials
    },
    config: {
      plugins: {
        'porg-auth': {
          type: 'no-auth'
        }
      }
    }
  })
}, test => {
  test.test('Test porg auth plugin', async function (t) {
    logger(['info', 'testing', 'test'], `Test porg auth plugin`)
    const options = {
      method: 'GET',
      url: '/api/emulate/auth/no-auth'
    }
    let response
    let expectedError = { type: 'no-auth' }
    try {
      response = await server.inject(options)
    } catch (err) {
      logger(['crit', 'testing', 'test'], err.message)
    } finally {
      t.deepEqual(response && response.result, expectedError) // Confirm endpoint result
      logger(['info', 'testing', 'test'], 'Test no porg auth plugin end')
      t.end()
    }
  })
})
