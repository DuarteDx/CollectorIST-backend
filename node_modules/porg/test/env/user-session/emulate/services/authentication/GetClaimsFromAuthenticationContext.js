import { Mongo, logger } from '@'

const GetUserFromUsername = async ({ username }) => {
  let db = await Mongo.getDB()
  return db.collection('users').findOne({ '_id': username })
}

const tags = ['auth', 'jwt', 'security', 'GetJwtPayloadForUsername', 'service']

export default async (ctx) => {
  const user = await GetUserFromUsername({ username: ctx.username })
  if (!user) {
    logger([...tags, 'error'], `Attempted to generate a JWT for the unknown user ${ctx.username}`)
    return null
  } else {
    logger([...tags, 'debug'], `Successfully generated a JWT for the user ${ctx.username}`)
    return {
      sub: ctx.username,
      roles: user.roles
    }
  }
}
