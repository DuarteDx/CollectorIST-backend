import { Mongo, loadMigrationFile } from '@'

export const dbVersion = '1.0.0'

export async function run () {
  const users = loadMigrationFile({ filename: 'profiles.json' })
  const db = await Mongo.getDB()
  db.collection('users').createIndex({ displayName: 'text' })
    .then(() => {
      var bulk = db.collection('users').initializeUnorderedBulkOp()
      users.forEach((u) => {
        bulk.find({_id: u.username}).upsert().update({
          $set: {
            _id: u.username,
            name: u.displayName,
            genre: u.genre,
            email: u.email,
            points: u.points,
            roles: u.roles }})
      })
      bulk.execute((err, results) => {
        if (err) {
          console.log(err)
        }
      })
    })
    .catch((err) => {
      console.log(err)
    })
}
