import Joi from 'joi'
import { tasks } from '@/tasks'

const handler = ({persistentTaskProvider}) => {
  return async (request, h) => {
    let input
    try {
      input = JSON.parse(request.payload.input)
    } catch (err) {
      input = JSON.parse({})
    }
    const task = await tasks.runTask({name: request.params.id, input})
    return {id: task.getId()}
  }
}

const config = ({roles, twoFactor}) => {
  return {
    description: 'Create task instance',
    validate: {
      params: {
        id: Joi.string().required()
      },
      payload: {
        input: Joi.string().required()
      }
    },
    plugins: {
      'porg-auth': {
        type: 'user-session',
        twoFactor,
        roles
      }
    }
  }
}

export default { handler, config }
