import path from 'path'
import fs from 'fs'
import { logger } from 'papagaio'

const ROUTES_FOLDER = 'routes'

export default async ({nodeStartPath}) => {
  let dirMainFile = path.dirname(require.main.filename)
  if (nodeStartPath) {
    dirMainFile = path.resolve(dirMainFile, nodeStartPath)
  }
  let normalizePath = path.join(dirMainFile, ROUTES_FOLDER)
  const plugins = []
  if (fs.existsSync(normalizePath)) {
    fs.readdirSync(normalizePath).forEach((file) => {
      const module = require(path.join(normalizePath, file))
      const route = module.plugin.route
      delete module.route
      try {
        const plugin = {
          plugin: module,
          routes: {prefix: route}
        }
        plugins.push(plugin)
      } catch (err) {
        logger(['error', 'porg', 'routes'], err.message)
      }
    })
  } else {
    logger(['warn', 'porg', 'routes'], 'Porg could not find any routes folder.')
  }
  return plugins
}
