import Joi from 'joi'
import ResolveChallengesService from '@/file-upload-handlers/services/ResolveChallengesService'

export default ({ persistenceProvider, fileUploadHandlerConfig }) => {
  const handler = async (request, h) => {
    return ResolveChallengesService({
      persistenceProvider,
      session: request.params.id,
      challenges: request.payload.challenges
    })
  }

  const config = {
    description: 'Resolves upload session challenges',
    validate: {
      params: {
        id: Joi.string().required()
      },
      payload: {
        challenges: Joi.array().items(Joi.string()).max(30).required()
      }
    },
    plugins: {
      ...fileUploadHandlerConfig.porgAuth && { 'porg-auth': fileUploadHandlerConfig.porgAuth }
    }
  }

  return {
    handler,
    config
  }
}
