import { Mongo, Elasticsearch, Consul } from '@/drivers'

export default async (options) => {
  const status = {}
  for (let key in options.drivers) {
    if (key === 'mongo') {
      const db = await Mongo.getDB()
      if (db.serverConfig.isConnected()) {
        status.mongo = {
          mongo_state: 'ok',
          mongo_stats: await db.stats()
        }
      } else {
        status.mongo = {
          mongo_state: 'failing'
        }
      }
    } else if (key === 'elasticsearch') {
      try {
        const client = await Elasticsearch.getClient()
        const ping = await client.ping({requestTimeout: 1000})
        status.elasticsearch = ping
      } catch (err) {
        status.elasticsearch = 'Failing'
      }
    } else if (key === 'consul') {
      try {
        const client = await Consul.consulClient
        await new Promise((resolve, reject) => {
          client.agent.self((err, result) => {
            if (err) {
              return reject(err)
            }
            return resolve(result)
          })
        })
        status.consul = 'ok'
      } catch (err) {
        status.consul = 'Failing'
      }
    }
  }
  return status
}
