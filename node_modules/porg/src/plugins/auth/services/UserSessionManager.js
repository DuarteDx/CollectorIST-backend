import { getJwt } from '@/plugins/auth/services/JwtUtils'

const setup = async ({ principal, config, h }) => {
  const token = await getJwt({
    payload: { ...principal, twoFactor: true },
    secretOrPrivateKey: config.jwt.secret,
    options: { expiresIn: config.jwt.expires || '1 hour' }
  })
  h.state('P_SESSION', token, {encoding: 'none', ttl: config.sessionTime * 1000, isSameSite: 'Strict', path: '/'})
  h.state('P_INFO', Buffer.from(JSON.stringify({ twoFactor: true, roles: principal.roles })).toString('base64'), {encoding: 'none', ttl: config.sessionTime * 1000, isSameSite: 'Strict', path: '/', isHttpOnly: false})
}

export default {
  setup
}
