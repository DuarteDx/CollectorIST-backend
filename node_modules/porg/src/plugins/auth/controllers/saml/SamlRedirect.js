import Joi from 'joi'

const handler = ({ samlOptions }) => {
  return async (request, h) => {
    return new Promise((resolve, reject) => {
      samlOptions.sp.create_login_request_url(samlOptions.idp, {
        relay_state: request.query.callbackUrl
      }, (err, loginUrl, requestId) => {
        if (err) {
          return reject(err)
        }
        return resolve(h.redirect(loginUrl))
      })
    })
  }
}

const config = {
  description: 'SAML Redirect Handler',
  validate: {
    query: {
      callbackUrl: Joi.string().required()
    }
  },
  cache: {
    privacy: 'private',
    expiresIn: 0
  },
  plugins: {
    'porg-auth': {
      type: 'no-auth'
    }
  }
}

export default { handler, config }
