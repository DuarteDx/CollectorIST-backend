import u2f from 'u2f'
// import { errorWithKey } from '@/plugins/erros'

const handler = (config) => {
  return async (request, h) => {
    const credentials = request.getPrincipal()
    let userU2F = await config.twoFactor.u2f.getUserU2F({ username: credentials.username })
    var checkRes = u2f.checkRegistration(userU2F.authRequest, request.payload)
    if (checkRes.successful) {
      await config.twoFactor.u2f.saveUserU2FChallenge({
        username: credentials.username,
        u2f: {
          publicKey: checkRes.publicKey,
          keyHandle: checkRes.keyHandle,
          certificate: checkRes.certificate
        }
      })
      return true
    } else {
      return false
    }
  }
}

const config = {
  description: 'Submit registration challenge for U2F',
  plugins: {
    'porg-auth': {
      type: 'user-session',
      roles: []
    }
  }
}

export default { handler, config }
