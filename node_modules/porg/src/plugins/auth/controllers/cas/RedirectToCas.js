import CAS from 'simple-cas-interface'
import Joi from 'joi'
import base64url from 'base64-url'

const handler = (casOptions) => {
  return async (request, h) => {
    const callback = base64url.encode(request.query.callbackUrl)
    const opts = {
      ...casOptions
    }
    opts.serviceUrl = opts.serviceUrl + `/${callback}`

    const cas = new CAS(opts)
    return h.redirect(cas.loginUrl)
  }
}

const config = {
  description: 'Redirects to CAS service',
  validate: {
    query: {
      callbackUrl: Joi.string().required()
    }
  },
  cache: {
    privacy: 'private',
    expiresIn: 0
  },
  plugins: {
    'porg-auth': {
      type: 'no-auth'
    }
  }
}

export default { handler, config }
