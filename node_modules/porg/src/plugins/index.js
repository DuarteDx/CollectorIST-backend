import path from 'path'
import fs from 'fs'
import { logger } from 'papagaio'

const PLUGINS_FOLDER = 'plugins'
export default async ({nodeStartPath}) => {
  let dirMainFile = path.dirname(require.main.filename)
  if (nodeStartPath) {
    dirMainFile = path.resolve(dirMainFile, nodeStartPath)
  }
  let normalizePath = path.join(dirMainFile, PLUGINS_FOLDER)
  const plugins = []
  if (fs.existsSync(normalizePath)) {
    fs.readdirSync(normalizePath).forEach((file) => {
      const module = require(path.join(normalizePath, file))
      const options = module.plugin.options
      delete module.options
      const plugin = {
        plugin: module,
        options
      }
      plugins.push(plugin)
    })
  } else {
    logger(['info', 'porg', 'plugins'], 'Porg could not find any plugins folder')
  }
  return plugins
}
