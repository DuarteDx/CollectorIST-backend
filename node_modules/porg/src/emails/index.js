import path from 'path'
import fs from 'fs'
import { logger } from 'papagaio'
import { setConfigEmail } from '@/emails/Email'

const EMAILS_FOLDER = 'emails_templates'

const templateMap = {}

const startConfig = async ({ emailConfig, templateMap, templatePath }) => {
  await setConfigEmail({ emailConfig, templateMap, templatePath })
}

export default async ({nodeStartPath, emailConfig}) => {
  let dirMainFile = path.dirname(require.main.filename)
  if (nodeStartPath) {
    dirMainFile = path.resolve(dirMainFile, nodeStartPath)
  }
  let normalizePath = path.join(dirMainFile, EMAILS_FOLDER)
  if (fs.existsSync(normalizePath)) {
    fs.readdirSync(normalizePath).forEach((file) => {
      const content = fs.readFileSync(path.join(normalizePath, file), 'utf8')
      const templateName = file.replace(/.njk$/, '')
      templateMap[templateName] = content
    })
  } else {
    logger(['info', 'porg', 'plugins'], 'Porg could not find any emails_templates folder')
  }
  await startConfig({ emailConfig, templateMap, templatePath: normalizePath })
}
